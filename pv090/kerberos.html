<?xml version="1.0" encoding="iso-8859-2"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html>
<head>
<!--
<link rel="stylesheet" href="http://www.fi.muni.cz/~kas/css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="http://www.fi.muni.cz/~kas/css/pv090ref.css" type="text/css" media="screen" />
-->
<title>Autentizaèní systémy</title>
</head>
<body>

<div id="nadpis">
<h1>Autentizaèní systémy</h1>
<h2>Martin Bukatoviè, xbukatov@fi.muni.cz</h2>
</div>

<h2>Obsah</h2>
<ul>
<li><a href="#kerb">Kerberos</a></li>
<ul>
    <li><a href="#kerb:princip">Princip fungování protokolu</a></li>
    <li><a href="#kerb:auth">Prùbìh autentizace</a></li>
    <li><a href="#kerb:impl">Dostupné implementace</a></li>
    <li><a href="#kerb:conf">Instalace a konfigurace</a></li>
    <li><a href="#kerb:note">Poznámky</a></li>
</ul>
<li><a href="#pam">PAM</a></li>
<ul>
    <li><a href="#pam:principy">Principy</a></li>
    <li><a href="#pam:conf">Konfigurace</a></li>
</ul>
<li><a href="#literatura">Literatura</a></li>
</ul>

<h2 id="kerb">Kerberos</h2>
<p>Kerberos je sí»ový autentizaèní protokol pracující na principu jednotného pøihla¹ování mezi nìkolika rùznými systémy. Jméno pochází z øecké mytologie, kde oznaèuje bájného trojhlavého psa, jeho¾ úkol bylo støe¾it vchod do podsvìtí.</p>
<p>Protokol byl vyvinut v rámci projektu Athena na MIT a první veøejnì dostupná verze 4 pochází z roku 1987. V roce 1993 byla definována v <a href="http://tools.ietf.org/html/rfc1510">RFC1510</a> 5. verze protokolu. Dnes se pou¾ívá aktualizovaná protokolu v5, která je popsána v <a href="http://tools.ietf.org/html/rfc4120">RFC4120</a> z roku 2005.</p>

<h3 id="kerb:princip">Princip fungování protokolu</h3>
<p>Kerberos øe¹í problém centrální autentizace v sí»ovém prostøedí, kde u¾ivatelé ze svých strojù pøistupují k mnoha dal¹ím slu¾bám dostupných pøes sí». Cílem bylo vytvoøit systém zaji¹»ující:</p>

<ul>
<li>Bezpeènost - poèítá se s nepøítelem ve vlastní sítí, odposlech kterékoli èásti komunikace nesmí umo¾nit její zneu¾ití.</li>
<li>Single Sing-On - u¾ivatel zadává heslo jen jednou na zaèátku práce, dal¹í ovìøování pøi pøístupu k sí»ových slu¾bám probíhá automaticky.</li>
<li>Centralizovanou správu - v síti existuje vyhrazený server, který zprostøedkovává autentizaci mezi klienty a slu¾bami a plní tak úlohu dùvìryhodné tøetí strany.</li>
</ul>

<p>Úlohu dùvìryhodného prostøedníka plní centrální autentizaèní server, tzv. <acronym>KDC</acronym> (Key Distribution Center), které spravuje databázi v¹ech hesel jak u¾ivatelù tak slu¾eb (jde o sdílené tajemství mezi u¾ivatelem/slu¾bou a KDC). <em>Realm</em> pak oznaèuje oblast spravovanou jedním KDC. U¾ivatele i slu¾by identifikuje tzv. <em>principal</em>, který má tvar: <pre>primary/instance@REALM</pre>Kde <em>primary</em> je buï jméno u¾ivatele nebo slu¾by, <em>instance</em> je doplòující informace (napø. adresa stroje, na kterém slu¾ba bì¾í nebo nepovinná u¾ivatelská role) a <em>realm</em> je jméno realmu, které se volí dle DNS domény.</p>

<p>KDC je rozdìleno na dva servery:</p>
<ul>
<li><acronym>AS</acronym> (Authentification Server) - ovìøuje identitu u¾ivatele.</li>
<li><acronym>TGS</acronym> (Ticket Granting Server) - vydává lístky (tickets), které se pou¾ívají k autentizaci u slu¾eb místo hesla a neobsahují ¾ádné tajné informace.</li>
</ul>

<h3 id="kerb:auth">Prùbìh autentizace</h3>
<p>Pøi autentizaci se vyu¾ívá tzv. <em>lístek</em> (ticket), který obsahuje session-key slu¾by (pro kterou byl lístek vydán), principal u¾ivatele a slu¾by, èasové razítko a dobu platnosti. Nakonec jsou v¹echny tyto informace za¹ifrovány pomocí hesla slu¾by. Lístek je v rámci své ¾ivotnosti znovupou¾itelný.</p> 

<p>Naopak <em>autentikátor</em> (authenticator) je pou¾itelný pouze jednou, ¹ifrovaný je pomocí session-key dané slu¾by a obsahuje principal u¾ivatele a èasovou známku.</p>

<p>Autentizace probíhá pøibli¾nì následujícím zpùsobem:</p>

<ul>
<li>Na poèátku u¾ivatelova sezení je spu¹tìn program <code>kinit</code>:
<ol>
<li><code>kinit</code> od u¾ivatele vy¾ádá heslo</li>
<li><code>kinit</code> po¹le na AS ¾ádost obsahující pouze <code>principal</code> u¾ivatele</li>
<li>pokud AS nalezne pro zaslaný principal záznam ve své databázi, ode¹le zpìt <code>ticket-granting-ticket</code> a vygeneruje <code>ticket-granting-session-key</code>, který po¹le zpìt za¹ifrovaný pomocí hesla u¾ivatele.</li>
<li>pokud bylo zadané heslo správné, <code>kinit</code> získá <code>ticket-granting-ticket</code> a <code>ticket-granting-session-key</code> pro pozdìj¹í pou¾ití. Platnost ticket granting lísku je omezena na nìkolik hodin a po jeho expiraci musí u¾ivatel po¾ádat o nový.</li>
</ol>
</li>

<br/><li>U¾ivatel poprvé v tomto sezení spustí klienta kerberizované slu¾by:
<ol>
<li>klient nejprve ode¹le ¾ádost na TGS obsahující:
<ul>
<li><code>ticket-granting-authenticator</code> (¹ifrovaný pomocí <code>ticket-granting-session-key</code>)</li>
<li><code>ticket-granting-ticket</code></li>
<li>principal u¾ivatele</li>
<li>principal slu¾by</li>
</ul>
</li>
<li>TGS autentizuje u¾ivatele (pomocí svého hesla roz¹ifruje <code>ticket-granting-ticket</code> a znìj pak získá <code>ticket-granting-session-key</code>, kterým se pokusí roz¹ifrovat <code>ticket-granting-authenticator</code> - pak lze porovnat takto získaný u¾ivatelský principal s zaslaným a tím u¾ivatele ovìøit) a ode¹le zpìt <code>serv-ticket</code> a <code>serv-session-key</code> pro danou slu¾bu, <code>serv-session-key</code> je za¹ifrovaný pomocí <code>ticket-granting-session-key</code></li>

<li>klient uchová <code>serv-ticket</code> a <code>serv-session-key</code> pro dal¹í pou¾ití</li>
<li>klient se autentizuje u slu¾by jak je popsáno dále</li>
</ol>
</li>

<br/><li>U¾ivatel spou¹tí klienta kerberizované slu¾by, který u¾ má z døívìj¹ka k dispozici <code>serv-ticket</code> i <code>serv-session-key</code>.</li>

<ol>
<li>klient nejdøíve ode¹le ¾ádost na server své slu¾by obsahující:
<ul>
<li><code>authenticator</code> (¹ifrovaný pomocí <code>serv-session-key</code>)</li>
<li><code>serv-ticket</code></li>
<li>principal u¾ivatele</li>
</ul>
</li>
<li>server autentizuje u¾ivatele a ode¹le zpìt èasovou známku (který získal z autentikátoru) zvìt¹enou o 1 a za¹ifrovanou pomocí <code>serv-session-key</code></li>
<li>klient pomocí <code>serv-session-key</code> roz¹ifruje data od serveru slu¾by a porovnáním èasové známky jej autentizuje</li>
<li>klient ode¹le na server slu¾by svùj po¾adavek</li>
</ul>

<h3 id="kerb:impl">Dostupné imlementace</h3>
<p>Mezi nejvýznamnìj¹í implementace protokolu Kebreros v5 patøí:</p>
<ul>
<li><b><a href="http://web.mit.edu/kerberos/www/">MIT Kerberos</a></b><br/>
Referenèní implementace vyvinutá pøímo na MIT. Od verze 4 byla licencována pod BSD licencí, ale její ¹íøení mimo USA nebylo mo¾né, proto¾e kód z MIT obsahoval ¹ifrovací algoritmus DES. V souèasnosti ji¾ toto omezení neplatí.
</li>
<li><b><a href="http://www.h5l.org/">Heimdal</a></b><br/>
Z dùvodù omezení vývozu ¹ifrovacích technologií vznikla na Královském technologickém institutu v Stokholmu alternativní implementace, kterou bylo mo¾né pou¾ívat i mimo USA. Heimdal implementuje protokoly verze 4 a 5 a je kompatibilní s MIT verzí a¾ na administraèní utilitu kadmin, která nebyla souèástí standardu. Heimdal je uvolnìn pod BSD licencí.
</li>
</ul>

<p>Nìkteré dal¹í projekty implementující Kerberos:</p>
<ul>
<li><b>GNU Shishi</b><br/>
Jde o projekt FSF vyvíjený pod GPLv3, zatím stále v raném stádiu vývoje.</li>
<li><b>J2SE</b><br/>
Souèástí standardní knihovny jazyka Java je podpora pro klientskou a serverovou èást protokolu Kerberos.</li> <!-- javax.security.auth.kerberos -->
<li><b>Windows</b><br/>
Kerberos je vyu¾it i v rámci tzv. <em>Active Directory</em> pou¾ívaného ve sítích s Windows.</li>
</ul>

<h3 id="kerb:conf">Instalace a konfigurace</h3>
<p>V distribuci Debian je tøeba nainstalovat balíèky krb5-admin-server a krb5-kdc, které obsahují MIT implementaci Kerbera.</p>

<p>Dùle¾ité konfiguraèní souboru jsou <code>krb5.conf</code>, který je hlavním konfiguraèním souborem - ovlivòuje chování klientù i serveru, a <code>kdc.conf</code>, v kterém se nastavuje KDC server.</p>

<h4>krb5.conf</h4>
<p>Bì¾nì se nachází v <code>/etc</code>, pokud neurèíme v promìnné prostøedí KRB5_CONFIG jinak. Jednoduchý pøíklad:</p>

<pre>
# nastavení Kerberos knihovny
[libdefaults]
  # výchozí nastavení realmu pro klienty
  default_realm = ATHENA.MIT.EDU
  # pou¾ít DNS SRV záznam pøi hledání KDC serveru
  dns_lookup_kdc = false
  # pou¾ít DNS TXT záznam pøi urèovaní realmu hostitele
  dns_lookup_realm = false

# nastavení pro jednotlivé realmy
[realms]
  ATHENA.MIT.EDU = {
    kdc = kerberos.athena.mit.edu
    admin_server = kerberos.athena.mit.edu
}

# mapování DNS na realmy
[domain_realm]
  .athena.mit.edu = ATHENA.MIT.EDU # cela domena
  athena.mit.edu = ATHENA.MIT.EDU  # hostname

[kdc]
  profile = /var/kerberos/krb5kdc/kdc.conf

[logging]
  kdc = SYSLOG:INFO:DAEMON
  admin_server = FILE:/var/log/kadmin.log
  default = SYSLOG
</pre>

<p>Sekci <code>[domain_realm]</code> lze vynechat, pokud se DNS doména shoduje s realmem (co¾ je doporuèeno). Dále je mo¾né vynechat i <code>[realms]</code>, pokud nastavíme odpovídající DNS SRV pro servery v realmu, nicménì útokem na DNS je pak mo¾né dosáhnout napø. odepøení slu¾by.</p>

<h3 id="kerb:note">Poznámky</h3>
<p>Kvùli pou¾ití èasových známek je nutné zajistit synchronizaci èasu v celém realmu napø. pomocí NTP.</p>
<p>Slu¾ba mù¾e autentizace s pomocí Kerbera vyu¾ít, pouze pokud je na to pøipravená. V praxi je tøeba pou¾ít tzv. <em>kerberizovanou verzi</em>. Na Debianu mají takové balíèky prefix <em>kbr-</em>, napø. krb-ftpd, krb5-telnetd a pod. Dále je pro ka¾dou takovou slu¾bu vytvoøit principal a pøenést k ní její klíè (soubor keytab) a konfiguraèní soubor krb5.conf.</p>

<h2 id="pam">PAM</h2>
<p>S autentizaèním systémem PAM (<em>Pluggable Authentication Modules</em>) pøi¹la firma Sun a dnes je pøítomen na vìt¹inì systémù unixového typu. Základní my¹lenkou je oddìlení konkrétní autentizaèní èásti programù do jedné spoleèné knihovny. Ta poskytuje obecné rozhraní a oddìluje tak programy od implementaèních detailù autentizaèních metod. To pak umo¾òuje programùm jako XDM pou¾ívat autentizaci pomocí hesla, otisku prstu nebo èipové karty. Existují implementace pod GPL - Linux-PAM, i BSD licencí - OpenPAM.</p>

<h3 id="pam:principy">Principy</h3>

<p>V praxi je ka¾dý program, který potøebuje autentizovat u¾ivatele, slinkovaný s knihovnou <code>libpam</code> obalující pluginy (na Linuxu umístìné v <code>/lib/security/</code>), které implementují konkrétní autentizaèní mechanismy.</p>

<p>Autentizaèní moduly jsou rozdìleny dle èinnosti do tìchto skupin:</p>
<ul>
<li><b>account</b> - Ovìøování úètu: Neexpiroval? Je aktivní? Je povolen pøístup ke slu¾bì?</li>
<li><b>auth</b> - Vlastní autentizace u¾ivatelù, napø. pomocí hesla, èipové karty, jednorázového hesla a pod.</li>
<li><b>session</b> - Provádí dal¹í akce pøed i po zpøístupnìní slu¾by, napø. nastavení prostøedí nebo auditování. </li>
<li><b>password</b> - Zaji¹tìní zmìn autentizaèních údajù - napø. hesla, tokenu a pod. </li>
</ul>

<p>Vybrané zajímavé moduly:</p>

<ul>
<li>pam_krb5.so - provádí autentizaci Kerberem (u¾ivatel nemusí ruènì spou¹tìt program <code>kinit</code>)</li>
<li>pam_time.so - omezuje pøihlá¹ení dle èasu</li>
<li>pam_securetty.so - kontrola terminálu dle <code>/etc/securetty</code></li>
<li>pam_unix.so - klasická unixová autentizace</li>
<li>pam_limits.so - nastavení limitù (viz <code>ulimit</code>, ochrana pøed neopatrnými u¾ivateli)</li>
<li>pam_deny.so - v¾dy skonèí neúspì¹nì</li>
<li>pam_cracklib.so - testuje kvalitu hesla</li>
<li>pam_exec.so - spustí externí program</li>
<li>pam_delay.so - zdr¾uje pøihla¹ování pøi chybné autentizaci</li>
</ul>

<h3 id="pam:conf">Konfigurace</h3>
<p>Konfigurace je umístìna buï v jednom souboru <code>/etc/pam.conf</code>, nebo rozdìlena dle programù v adresáøi <code>/etc/pam.d</code>, který pokud existuje, je <code>pam.conf</code> v¾dy ignorován.</p>

<p>Konfiguraèní soubor je procházen sekvenènì, na ka¾dém øádku je popsán jeden autentizaèní modul ve tvaru: skupina øídící-hodnota modul [argumenty-modulu]. Øídící hodnoty mohou být:</p>

<ul>
<li>required - Polo¾ka je povinná, pøi neúspìchu nakonec celá autentizace sel¾e.</li>
<li>requisite - Podobnì jako pøedchozí, ale autentizace sel¾e okam¾itì.</li>
<li>sufficient - Dostaèuje k autentizaci samo o sobì bez ohledu na ostatní moduly.</li>
<li>optional - V¾dy se provede, ale výsledek má na provedení autentizace vliv jen pokud jde o jediný modul své skupiny.</li>
<li>include  - Vlo¾ení pravidel z externího souboru.</li>
</ul>

<h4>Pøíklad</h4>

<p>Následující soubor <code>/etc/pam.d/passwd</code> zajistí, ¾e se pøi zmìnì hesla nejprve otestuje dle zadaných kritérií jeho kvalita - pokud tento test sel¾e, dál se nepokraèuje, jinak se nové heslo se ulo¾í do <code>/etc/shadow</code> s sha512 hashem:
<pre>
password        required        pam_cracklib.so difok=2 minlen=8 dcredit=2 ocredit=2 retry=3
password        required        pam_unix.so sha512 shadow nullok
</pre>
</p>

<p>Nebo <code>/etc/pam.s/sshd</code>:
<pre>
#auth           required        pam_securetty.so        #Disable remote root
auth            required        pam_unix.so
auth            required        pam_nologin.so
auth            required        pam_env.so
account         required        pam_unix.so
account         required        pam_time.so
password        required        pam_unix.so
session         required        pam_unix_session.so
session         required        pam_limits.so
</pre>
</p>

<h2 id="literatura">Literatura</h2>
<ul>
<li><a href="http://www.fi.muni.cz/~kas/p090/referaty/">Archív referátù</a></li>
<li><a href="http://www.fi.muni.cz/~kas/p077/p077.pdf">Slidy pøedná¹ky PV077</a></li>
<li><a href="http://web.mit.edu/kerberos/www/dialogue.html">Designing an Authentication System: a Dialogue in Four Scenes</a></li>
<li><a href="http://web.mit.edu/Kerberos/krb5-1.7/krb5-1.7/doc/krb5-admin.html">Kerberos V5 System Administrator's Guide</a></li>
<li><a href="http://kerberos.zdenda.com/">Kerberos: Instalace a pou¾ití</a></li>
<li><a href="http://www.abclinuxu.cz/clanky/bezpecnost/kerberos-prihlasovani-snadno-a-rychle">Kerberos: pøihla¹ování snadno a rychle</a></li>
<li><a href="http://techpubs.spinlocksolutions.com/dklar/kerberos.html">Debian GNU: Setting up MIT Kerberos 5</a></li>
<li>RFC <a href="http://tools.ietf.org/html/rfc1510">1510</a> a <a href="http://tools.ietf.org/html/rfc4120">4120</a></li>
<li>manuálové stránky PAMu</li>
</ul>
</body>
</html>
